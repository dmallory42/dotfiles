# =============================================================================
# ZSH Configuration - Optimized for stability, speed, and security
# =============================================================================

# -----------------------------------------------------------------------------
# Non-Interactive Shell Setup (for scripts, Claude Code, etc.)
# -----------------------------------------------------------------------------
if [[ ! -o interactive ]]; then
  # Minimal setup for non-interactive shells
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
  export PNPM_HOME="$HOME/Library/pnpm"
  export PATH="$PNPM_HOME:$PATH"
  export PATH="/opt/homebrew/opt/php/bin:$PATH"
  export PATH="/opt/homebrew/opt/php/sbin:$PATH"
  export PATH="$HOME/.local/bin:$PATH"
  if [ -f ~/.composer_bin_path ]; then
    export PATH="$(cat ~/.composer_bin_path):$PATH"
  fi
  return
fi

# -----------------------------------------------------------------------------
# Security Settings
# -----------------------------------------------------------------------------
umask 027  # Files: rw-r-----, Dirs: rwxr-x---

# -----------------------------------------------------------------------------
# History Configuration (Stability)
# -----------------------------------------------------------------------------
HISTFILE=~/.zsh_history
HISTSIZE=50000
SAVEHIST=50000
setopt HIST_IGNORE_DUPS      # Don't record duplicates
setopt HIST_IGNORE_SPACE     # Don't record commands starting with space
setopt SHARE_HISTORY         # Share history between sessions
setopt HIST_VERIFY           # Show command before executing from history
setopt INC_APPEND_HISTORY    # Write immediately, not on exit

# -----------------------------------------------------------------------------
# Oh My Zsh Configuration
# -----------------------------------------------------------------------------
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"

# -----------------------------------------------------------------------------
# NVM Configuration (must be before oh-my-zsh loads zsh-nvm plugin)
# -----------------------------------------------------------------------------
export NVM_DIR="$HOME/.nvm"
export NVM_LAZY_LOAD=true           # Lazy load for fast startup
export NVM_AUTO_USE=true            # Auto-switch on .nvmrc detection

# Plugins - install additional plugins with:
plugins=(
  git
  docker
  zsh-nvm                    # Handles nvm lazy loading & .nvmrc
  zsh-autosuggestions        # Uncomment after installing
  zsh-syntax-highlighting    # Uncomment after installing
)

source $ZSH/oh-my-zsh.sh

# -----------------------------------------------------------------------------
# Protective Aliases (Stability)
# -----------------------------------------------------------------------------
alias rm='rm -i'
alias mv='mv -i'
alias cp='cp -i'

# -----------------------------------------------------------------------------
# User Aliases
# -----------------------------------------------------------------------------
alias python="python3"
alias pip="pip3"

# -----------------------------------------------------------------------------
# pnpm
# -----------------------------------------------------------------------------
export PNPM_HOME="$HOME/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac

# -----------------------------------------------------------------------------
# Ensure Claude is installed (utility function)
# -----------------------------------------------------------------------------
install_claude_all_versions() {
  for version in $(nvm ls --no-colors | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+'); do
    nvm use $version > /dev/null 2>&1
    if ! command -v claude &> /dev/null; then
      echo "Installing claude-code for $version"
      npm install -g @anthropic-ai/claude-code
    else
      echo "claude-code already installed for $version"
    fi
  done
  nvm use default
}

# -----------------------------------------------------------------------------
# PHP Configuration
# -----------------------------------------------------------------------------
export PATH="/opt/homebrew/opt/php/bin:$PATH"
export PATH="/opt/homebrew/opt/php/sbin:$PATH"

# -----------------------------------------------------------------------------
# Composer - Cached path for faster startup
# To regenerate: composer global config bin-dir --absolute --quiet > ~/.composer_bin_path
# -----------------------------------------------------------------------------
if [ -f ~/.composer_bin_path ]; then
  export PATH="$(cat ~/.composer_bin_path):$PATH"
else
  # Fallback: evaluate at startup (slower)
  export PATH=$(composer global config bin-dir --absolute --quiet 2>/dev/null):$PATH
fi

# -----------------------------------------------------------------------------
# rbenv - Lazy loaded for faster shell startup
# -----------------------------------------------------------------------------
rbenv() {
  unset -f rbenv
  eval "$(command rbenv init - zsh)"
  rbenv "$@"
}

# -----------------------------------------------------------------------------
# SSH Agent Management (Security)
# -----------------------------------------------------------------------------
if [ -z "$SSH_AUTH_SOCK" ]; then
  eval "$(ssh-agent -s)" > /dev/null
  ssh-add --apple-use-keychain ~/.ssh/id_ed25519 2>/dev/null
  ssh-add --apple-use-keychain ~/.ssh/id_ed25519_github 2>/dev/null
fi

# -----------------------------------------------------------------------------
# Additional PATH entries
# -----------------------------------------------------------------------------
export PATH="$HOME/.local/bin:$PATH"

# -----------------------------------------------------------------------------
# PATH Deduplication (Stability) - Keep at end
# -----------------------------------------------------------------------------
typeset -U PATH path

[ -f "$HOME/.ghcup/env" ] && . "$HOME/.ghcup/env" # ghcup-env
export PATH="/opt/homebrew/opt/coreutils/libexec/gnubin:$PATH"

# -----------------------------------------------------------------------------
# Machine-specific overrides (not tracked in git)
# -----------------------------------------------------------------------------
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local
